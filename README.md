# Документация Сервиса Подписок

## Общее описание
Сервис реализует паттерн "Publisher-Subscriber" через gRPC. Основные возможности:
- Публикация сообщений по ключам (топикам)
- Подписка на сообщения по ключам с потоковой доставкой
- Graceful Shutdown
- Конфигурирование через ENV/флаги

## Архитектура

### Основные компоненты
1. **gRPC Server** (cmd/server) - точка входа, инициализация системы
2. **SubPub System** (pkg/subpub) - ядро системы публикаций/подписок
3. **Config** (internal/config) - управление конфигурацией
4. **gRPC Handlers** (internal/server) - обработчики gRPC-методов

## Описание модулей

### 1. Конфигурация (internal/config)
**Файл**: `config.go`

**Функции**:

- Валидация параметров
- Поддерживаемые параметры:
    - `GRPCPort` (порт gRPC-сервера)
    - `LogLevel` (уровень логирования)

### 2. Реализация шины событий (pkg/subpub)
**Файл**: `subpub.go`
В этой же директории лежат unit тесты - `subpub_test.go`

**Основные структуры**:
- `subPubImpl` - ядро системы:
    - Хранит подписчиков в `map[string][]*subscriber`
    - Обеспечивает потокобезопасность через `sync.RWMutex`

**Методы**:
- `Subscribe(subject, handler)` - подписка с callback
- `Publish(subject, msg)` - публикация сообщения
- `Close(ctx)` - graceful shutdown

**Особенности**:
- Буферизированные каналы (256 сообщений)
- Автоматическая очистка при отписке
- Защита от блокировок (select с default в Publish)

### 3. gRPC Ручки (internal/server)
**Файл**: `grpc.go`

**Метод Publish**:

- Валидация входящих данных
- Преобразование protobuf → внутренний формат
- Обработка ошибок:
    - `InvalidArgument` - пустые данные
    - `Unavailable` - при закрытии системы

**Метод Subscribe**:
- Инициализация подписки
- Создание буферизированного канала (10 сообщений)
- Горутина для отправки через поток
- Обработка разрыва соединения
- Автоматическая отписка при завершении

### 4. Основной модуль (cmd/server/main.go)
**Жизненный цикл**:
1. Инициализация логгера
2. Загрузка конфигурации
3. Создание SubPub системы
4. Запуск gRPC-сервера
5. Обработка сигналов OS
6. Graceful shutdown:
    - Остановка gRPC-сервера
    - Завершение SubPub системы





# Как Запустить


## Настройка и запуск

1. **Клонирование репозитория:**
   Откройте терминал и клонируйте репозиторий проекта. Замените `your-repo-url.git` на реальный URL.
   ```bash
   git clone https://github.com/plusha-fullstack/VK1
   ```

2. **Переход в директорию проекта:**
   ```bash
   cd proto
   ```

3. **Генерация кода Protobuf:**
   Из корня директории `grpc-subpub` выполните команду `protoc` для генерации Go-кода из `.proto` файла:
   ```bash
   protoc --go_out=. --go_opt=paths=source_relative \
          --go-grpc_out=. --go-grpc_opt=paths=source_relative \
          proto/pubsub.proto
   ```
   Это создаст или обновит файлы `proto/pubsub.pb.go` и `proto/pubsub_grpc.pb.go`.

4. **Загрузка зависимостей:**
   Убедитесь, что все зависимости Go-модулей загружены:
   ```bash
   go mod tidy
   ```

5. **Сборка сервера:**
   Перейдите в директорию команд сервера и соберите исполняемый файл:
   ```bash
   cd cmd/server
   go build -o ../../pubsub_server
   cd ../..
   ```
   Теперь у вас должен быть исполняемый файл с именем `pubsub_server` в корне директории `grpc-subpub`.

6. **Запуск сервера:**
   Запустите скомпилированный сервер. Вы можете указать порт через флаг:
   ```bash
   ./pubsub_server -grpc-port=9090
   ```
   Или использовать переменные окружения:
   ```bash
   GRPC_PORT=9090 ./pubsub_server
   ```
   Если порт не указан, будет использоваться значение по умолчанию — `8080` (или то, которое задано по умолчанию в конфиге).

   **Ожидаемый вывод:**
   Вы должны увидеть логи, сообщающие о том, что сервер успешно запущен и слушает указанный порт, например:
   Сервер теперь работает и готов принимать соединения.

## Взаимодействие с сервисом (с помощью `grpcurl`)

Для тестирования сервиса нужен gRPC клиент. Я пользовался `grpcurl` во время запусков.

1. **Установка `grpcurl` (если еще не установлен):**
   ```bash
   go install github.com/fullstorydev/grpcurl/cmd/grpcurl@latest
   ```

2. **Публикация сообщения:**
   Откройте **новое окно терминала** (оставьте сервер запущенным в первом).
   Замените `localhost:9090`, если сервер находится на другом порту.
   ```bash
   grpcurl -plaintext -d '{"key": "weather", "data": "Погода 1"}' localhost:9090 proto.PubSub/Publish
   ```
   **Ожидаемый результат:**
   Пустой JSON объект `{}` означает успех. В логах сервера должно появиться сообщение о получении запроса Publish.

3. **Подписка на сообщения:**
   Откройте **ещё одно окно терминала**.
   ```bash
   grpcurl -plaintext -d '{"key": "weather"}' localhost:9090 proto.PubSub/Subscribe
   ```
   Эта команда будет ждать новых событий по ключу "weather". В логах сервера должно появиться сообщение о получении запроса Subscribe.

4. **Публикация нового сообщения:**
   Вернитесь к терминалу, где вы отправляли первый Publish (или откройте новый), и отправьте ещё одно сообщение на тот же ключ:
   ```bash
   grpcurl -plaintext -d '{"key": "weather", "data": "Погода 2"}' localhost:9090 proto.PubSub/Publish
   ```
   **Ожидаемый результат:**
    *   Терминал с командой `Subscribe` отобразит новое событие:
        ```json
        {
          "data": "Погода 1"
        }
        {
          "data": "Погода 2"
        }
        ```
        *(Примечание: Первое сообщение может отобразиться, если оно было отправлено после подключения подписчика. Если оно было отправлено раньше, будут видны только последующие сообщения).*

## Остановка сервиса

*   Чтобы остановить клиент `Subscribe` (`grpcurl`), нажмите `Ctrl+C` в его терминале.
*   Чтобы остановить gRPC сервер, перейдите в терминал, где запущен `./pubsub_server`, и нажмите `Ctrl+C`. Вы должны увидеть сообщения о завершении работы сервера.

grpcurl -plaintext -proto ./pubsub.proto -d '{"key": "news", "data": "Hello from gRPC!"}' localhost:9090 proto.PubSub/Publish

grpcurl -plaintext -proto ./pubsub.proto -d '{"key": "news"}' localhost:9090 proto.PubSub/Subscribe

grpcurl -plaintext -proto ./pubsub.proto -d '{"key": "news", "data": "Another event!"}' localhost:9090 proto.PubSub/Publish

